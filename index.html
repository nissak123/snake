<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Doodle Jump Simple</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body {
            margin: 0; padding: 0;
            background: #f0f0f0;
            display: flex; flex-direction: column; align-items: center;
            height: 100vh; font-family: sans-serif;
            overflow: hidden; touch-action: none;
        }
        #gameContainer {
            position: relative; width: 320px; height: 500px;
            background: #fff; border: 2px solid #333;
        }
        canvas { display: block; background: #fff; }
        #score {
            position: absolute; top: 10px; left: 10px;
            font-size: 24px; font-weight: bold; pointer-events: none;
        }
        #start-button {
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            padding: 20px 40px; font-size: 20px;
            background: #2481cc; color: #fff;
            border: none; border-radius: 10px; z-index: 1000;
        }
        #controls { display: flex; gap: 40px; margin-top: 20px; }
        .btn {
            width: 80px; height: 80px; background: #2481cc;
            color: #fff; border-radius: 50%; border: none; font-size: 30px;
        }
    </style>
</head>
<body>

<div id="gameContainer">
    <div id="score">0</div>
    <canvas id="gameCanvas" width="320" height="500"></canvas>
    <button id="start-button">СТАРТ</button>
</div>

<div id="controls">
    <button id="left-btn" class="btn">◀</button>
    <button id="right-btn" class="btn">▶</button>
</div>

<script>
    const tg = window.Telegram.WebApp;
    tg.ready();
    tg.expand();

    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const startBtn = document.getElementById('start-button');
    const scoreDiv = document.getElementById('score');

    const playerImg = new Image();
    playerImg.src = 'player.png'; 

    let player = { x: 135, y: 300, w: 50, h: 50, dx: 0, dy: 0 };
    let platforms = [];
    let particles = [];
    let score = 0;
    let gameOver = true;
    let gameInterval;
    let currentWidth = 70;

    function createPlatforms() {
        platforms = [];
        currentWidth = 70;
        platforms.push({ x: 110, y: 420, w: 100, h: 15, mv: 0 });
        for(let i = 1; i < 7; i++) {
            platforms.push({ x: Math.random()*240, y: 420-(i*80), w: 70, h: 12, mv: Math.random()>0.7?2:0 });
        }
    }

    function init() {
        console.log("Игра запущена");
        gameOver = false;
        startBtn.style.display = 'none';
        score = 0;
        scoreDiv.textContent = '0';
        player.x = 135; player.y = 300; player.dy = 0;
        createPlatforms();
        if(gameInterval) clearInterval(gameInterval);
        gameInterval = setInterval(update, 1000/60);
    }

    function update() {
        if(gameOver) return;
        player.dy += 0.28;
        player.y += player.dy;
        player.x += player.dx;

        if (player.x < -30) player.x = 320;
        if (player.x > 320) player.x = -30;

        // Сложность
        if (score > 0 && score % 1000 < 50 && score/1000 >= platforms.length/100) { // грубая проверка на порог
             // (упростили пока для теста стабильности)
        }

        platforms.forEach(p => {
            if (p.mv) {
                p.x += p.mv;
                if (p.x <= 0 || p.x + p.w >= 320) p.mv *= -1;
            }
            if (player.dy > 0 && player.x < p.x + p.w && player.x + player.w > p.x &&
                player.y + player.h > p.y && player.y + player.h < p.y + p.h + 10) {
                player.dy = -10;
                score += 100; // Для теста сразу по 100 за прыжок
                scoreDiv.textContent = score;
                tg.HapticFeedback.impactOccurred('medium');
            }
        });

        if (player.y < 200) {
            let offset = 200 - player.y;
            player.y = 200;
            platforms.forEach(p => {
                p.y += offset;
                if (p.y > 500) { p.y = -20; p.x = Math.random()*240; }
            });
        }

        if (player.y > 500) {
            gameOver = true;
            startBtn.style.display = 'block';
            startBtn.textContent = "ЕЩЕ РАЗ";
        }
        draw();
    }

    function draw() {
        ctx.clearRect(0, 0, 320, 500);
        ctx.fillStyle = "green";
        platforms.forEach(p => ctx.fillRect(p.x, p.y, p.w, p.h));
        if (playerImg.complete) {
            ctx.drawImage(playerImg, player.x, player.y, player.w, player.h);
        } else {
            ctx.fillStyle = "orange";
            ctx.fillRect(player.x, player.y, player.w, player.h);
        }
    }

    // УПРАВЛЕНИЕ - самые простые события
    const L = document.getElementById('left-btn');
    const R = document.getElementById('right-btn');

    L.ontouchstart = L.onmousedown = (e) => { e.preventDefault(); player.dx = -5; };
    R.ontouchstart = R.onmousedown = (e) => { e.preventDefault(); player.dx = 5; };
    window.ontouchend = window.onmouseup = () => { player.dx = 0; };

    startBtn.onclick = init;
    startBtn.ontouchstart = (e) => { e.preventDefault(); init(); };

    draw();
</script>
</body>
</html>
