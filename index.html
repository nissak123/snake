<!DOCTYPE html>

<html lang="ru">

<head>

    <meta charset="UTF-8">

    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <title>Doodle Jump Challenge</title>

    <script src="https://telegram.org/js/telegram-web-app.js"></script>

    <style>

        :root {

            --tg-bg: var(--tg-theme-bg-color, #ffffff);

            --tg-btn: var(--tg-theme-button-color, #2481cc);

            --tg-btn-text: var(--tg-theme-button-text-color, #ffffff);

        }

        body {

            font-family: 'Arial', sans-serif;

            background-color: #f0f0f0;

            margin: 0;

            display: flex;

            flex-direction: column;

            align-items: center;

            justify-content: center;

            height: 100vh;

            overflow: hidden;

            touch-action: none;

        }

        body.dark-theme {

            background-color: #1a1a1a;

        }

        #gameContainer {

            position: relative;

            width: 320px;

            height: 500px;

            background-color: #ffffff;

            border: 2px solid #ddd;

            overflow: hidden;

            box-shadow: 0 10px 30px rgba(0,0,0,0.1);

        }

        body.dark-theme #gameContainer {

            background-color: #2a2a2a;

            border-color: #444;

        }

        #score {

            position: absolute;

            top: 15px; left: 15px;

            font-size: 26px; font-weight: 900; color: #333;

            z-index: 5;

        }

        body.dark-theme #score {

            color: #fff;

        }

        #menuButton {

            position: absolute;

            top: 15px; right: 15px;

            width: 40px; height: 40px;

            background: var(--tg-btn);

            border: none;

            border-radius: 8px;

            color: white;

            font-size: 24px;

            z-index: 5;

            cursor: pointer;

        }

        #startScreen, #menuScreen {

            position: absolute;

            inset: 0;

            background: rgba(255,255,255,0.95);

            display: flex;

            flex-direction: column;

            align-items: center;

            justify-content: center;

            z-index: 10;

        }

        body.dark-theme #startScreen,

        body.dark-theme #menuScreen {

            background: rgba(42,42,42,0.95);

        }

        #menuScreen {

            display: none;

        }

        .menu-title {

            font-size: 28px;

            font-weight: bold;

            margin-bottom: 30px;

            color: #333;

        }

        body.dark-theme .menu-title {

            color: #fff;

        }

        .menu-item {

            width: 280px;

            padding: 15px;

            margin: 8px 0;

            background: #f5f5f5;

            border: 2px solid #ddd;

            border-radius: 10px;

            font-size: 16px;

            color: #333;

        }

        body.dark-theme .menu-item {

            background: #3a3a3a;

            border-color: #555;

            color: #fff;

        }

        .menu-item-header {

            font-weight: bold;

            margin-bottom: 5px;

        }

        .toggle-buttons {

            display: flex;

            gap: 10px;

            margin-top: 8px;

        }

        .toggle-btn {

            flex: 1;

            padding: 8px;

            background: #ddd;

            border: none;

            border-radius: 6px;

            font-size: 14px;

            cursor: pointer;

        }

        .toggle-btn.active {

            background: var(--tg-btn);

            color: white;

        }

        #start-button, #closeMenuBtn {

            padding: 18px 35px;

            background: var(--tg-btn);

            color: var(--tg-btn-text);

            border: none;

            border-radius: 15px;

            font-size: 20px;

            font-weight: bold;

            margin-top: 20px;

            cursor: pointer;

        }

        #mathQuiz {

            position: absolute;

            inset: 0;

            background: rgba(0,0,0,0.9);

            display: none;

            flex-direction: column;

            align-items: center;

            justify-content: center;

            z-index: 20;

        }

        .quiz-question {

            font-size: 32px;

            color: white;

            margin-bottom: 20px;

            font-weight: bold;

        }

        .quiz-timer {

            font-size: 24px;

            color: #ff4444;

            margin-bottom: 30px;

        }

        .quiz-answers {

            display: flex;

            flex-direction: column;

            gap: 15px;

        }

        .quiz-answer {

            padding: 15px 50px;

            background: white;

            border: none;

            border-radius: 10px;

            font-size: 24px;

            font-weight: bold;

            cursor: pointer;

        }

        .quiz-answer:hover {

            background: #e0e0e0;

        }

        #controls {

            display: flex;

            gap: 60px;

            margin-top: 25px;

        }

        .btn {

            width: 75px; height: 75px;

            background: var(--tg-btn);

            border-radius: 50%;

            border: none;

            color: white;

            font-size: 30px;

            box-shadow: 0 4px 10px rgba(0,0,0,0.2);

            user-select: none;

            -webkit-user-select: none;

        }

    </style>

</head>

<body>



    <div id="gameContainer">

        <div id="score">0</div>

        <button id="menuButton">‚ò∞</button>

        <canvas id="gameCanvas" width="320" height="500"></canvas>

        

        <div id="startScreen">

            <button id="start-button">–ü–û–ì–ù–ê–õ–ò!</button>

        </div>

        

        <div id="menuScreen">

            <div class="menu-title">–ú–ï–ù–Æ</div>

            

            <div class="menu-item">

                <div class="menu-item-header">üèÜ –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è</div>

                <div>–õ—É—á—à–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: <span id="bestScore">0</span></div>

            </div>

            

            <div class="menu-item">

                <div class="menu-item-header">üéÆ –†–µ–∂–∏–º –∏–≥—Ä—ã</div>

                <div class="toggle-buttons">

                    <button class="toggle-btn active" id="modeClassic">–ö–ª–∞—Å—Å–∏–∫–∞</button>

                    <button class="toggle-btn" id="modeAnal">–ê–Ω–∞–ª</button>

                </div>

            </div>

            

            <div class="menu-item">

                <div class="menu-item-header">üîä –ó–≤—É–∫</div>

                <div class="toggle-buttons">

                    <button class="toggle-btn active" id="soundOn">–û—Ä—É</button>

                    <button class="toggle-btn" id="soundOff">–ó–∞–≤–∞–ª–∏–ª</button>

                </div>

            </div>

            

            <div class="menu-item">

                <div class="menu-item-header">üé® –¢–µ–º–∞</div>

                <div class="toggle-buttons">

                    <button class="toggle-btn active" id="themeLight">–°–≤–µ—Ç–ª–∞—è</button>

                    <button class="toggle-btn" id="themeDark">–¢—ë–º–Ω–∞—è</button>

                </div>

            </div>

            

            <button id="closeMenuBtn">–ó–∞–∫—Ä—ã—Ç—å</button>

        </div>

        

        <div id="mathQuiz">

            <div class="quiz-question" id="quizQuestion"></div>

            <div class="quiz-timer">–û—Å—Ç–∞–ª–æ—Å—å: <span id="quizTimer">5</span> —Å–µ–∫</div>

            <div class="quiz-answers" id="quizAnswers"></div>

        </div>

    </div>



    <div id="controls">

        <button id="left-btn" class="btn">‚óÄ</button>

        <button id="right-btn" class="btn">‚ñ∂</button>

    </div>



    <script>

        const tg = window.Telegram.WebApp;

        tg.ready();

        tg.expand();



        const canvas = document.getElementById('gameCanvas');

        const ctx = canvas.getContext('2d');

        const scoreDiv = document.getElementById('score');

        const startScreen = document.getElementById('startScreen');

        const menuScreen = document.getElementById('menuScreen');

        const mathQuiz = document.getElementById('mathQuiz');



        const playerImg = new Image();

        playerImg.src = 'player.png?v=' + Date.now(); 



        let player = { x: 135, y: 300, w: 50, h: 50, dx: 0, dy: 0 };

        let platforms = [];

        let particles = [];

        let score = 0;

        let bestScore = localStorage.getItem('bestScore') || 0;

        let gameOver = true;

        let gameInterval;

        let quizTimer;

        let quizTimeLeft = 5;

        

        const BASE_PLATFORM_WIDTH = 70;

        let currentPlatformWidth = BASE_PLATFORM_WIDTH;

        let lastDifficultyTier = 0;

        

        let leftPressed = false;

        let rightPressed = false;

        let lastPressed = null;

        let activeTouches = new Map();

        

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∏

        let soundEnabled = true;

        let darkTheme = false;

        let gameMode = 'classic';



        document.getElementById('bestScore').textContent = bestScore;



        function createPlatforms() {

            platforms = [];

            currentPlatformWidth = BASE_PLATFORM_WIDTH;

            lastDifficultyTier = 0;

            platforms.push({ x: 110, y: 420, w: 100, h: 15, mv: 0, breakable: false, used: false });

            for(let i = 1; i < 7; i++) {

                addPlatform(420 - (i * 80));

            }

        }



        function addPlatform(yPos) {

            const isMoving = Math.random() > 0.6;

            const isBreakable = Math.random() > 0.7;

            platforms.push({

                x: Math.random() * (320 - currentPlatformWidth),

                y: yPos,

                w: currentPlatformWidth,

                h: 12,

                mv: isMoving ? (Math.random() - 0.5) * 4 : 0,

                breakable: isBreakable,

                used: false

            });

        }



        function createGoldParticles(x, y) {

            for (let i = 0; i < 8; i++) {

                particles.push({

                    x: x + player.w / 2,

                    y: y + player.h,

                    vx: (Math.random() - 0.5) * 4,

                    vy: Math.random() * -3 - 1,

                    life: 40,

                    size: 4 + Math.random() * 3,

                    color: "#FFD700"

                });

            }

        }



        function createBreakParticles(p) {

            for (let i = 0; i < 12; i++) {

                particles.push({

                    x: p.x + p.w / 2,

                    y: p.y + p.h / 2,

                    vx: (Math.random() - 0.5) * 6,

                    vy: (Math.random() - 0.5) * 6,

                    life: 30,

                    size: 3 + Math.random() * 2,

                    color: "#8B4513"

                });

            }

        }



        function drawRoundedRect(x, y, w, h, radius) {

            ctx.beginPath();

            ctx.moveTo(x + radius, y);

            ctx.lineTo(x + w - radius, y);

            ctx.arcTo(x + w, y, x + w, y + radius, radius);

            ctx.lineTo(x + w, y + h - radius);

            ctx.arcTo(x + w, y + h, x + w - radius, y + h, radius);

            ctx.lineTo(x + radius, y + h);

            ctx.arcTo(x, y + h, x, y + h - radius, radius);

            ctx.lineTo(x, y + radius);

            ctx.arcTo(x, y, x + radius, y, radius);

            ctx.closePath();

            ctx.fill();

        }



        function drawCrackedPlatform(x, y, w, h, radius) {

            // –†–∏—Å—É–µ–º –æ—Å–Ω–æ–≤—É

            ctx.fillStyle = "#6B3410";

            drawRoundedRect(x, y, w, h, radius);

            

            // –†–∏—Å—É–µ–º —Ç—Ä–µ—â–∏–Ω—ã

            ctx.strokeStyle = "#3a1d08";

            ctx.lineWidth = 1.5;

            

            ctx.beginPath();

            ctx.moveTo(x + w * 0.3, y);

            ctx.lineTo(x + w * 0.35, y + h);

            ctx.stroke();

            

            ctx.beginPath();

            ctx.moveTo(x + w * 0.7, y);

            ctx.lineTo(x + w * 0.65, y + h);

            ctx.stroke();

            

            ctx.beginPath();

            ctx.moveTo(x, y + h * 0.5);

            ctx.lineTo(x + w, y + h * 0.5);

            ctx.stroke();

        }



        function updatePlayerDirection() {

            if (leftPressed && rightPressed) {

                if (lastPressed === 'left') {

                    player.dx = -5;

                } else {

                    player.dx = 5;

                }

            } else if (leftPressed) {

                player.dx = -5;

            } else if (rightPressed) {

                player.dx = 5;

            } else {

                player.dx = 0;

            }

        }



        function showMathQuiz() {

            const num1 = Math.floor(Math.random() * 900) + 100;

            const num2 = Math.floor(Math.random() * 900) + 100;

            const correctAnswer = num1 + num2;

            

            const wrong1 = correctAnswer + Math.floor(Math.random() * 100) - 50;

            const wrong2 = correctAnswer + Math.floor(Math.random() * 100) - 50;

            

            const answers = [correctAnswer, wrong1, wrong2].sort(() => Math.random() - 0.5);

            

            document.getElementById('quizQuestion').textContent = `${num1} + ${num2} = ?`;

            

            const answersContainer = document.getElementById('quizAnswers');

            answersContainer.innerHTML = '';

            

            answers.forEach(answer => {

                const btn = document.createElement('button');

                btn.className = 'quiz-answer';

                btn.textContent = answer;

                btn.onclick = () => checkAnswer(answer, correctAnswer);

                answersContainer.appendChild(btn);

            });

            

            mathQuiz.style.display = 'flex';

            quizTimeLeft = 5;

            document.getElementById('quizTimer').textContent = quizTimeLeft;

            

            quizTimer = setInterval(() => {

                quizTimeLeft--;

                document.getElementById('quizTimer').textContent = quizTimeLeft;

                if (quizTimeLeft <= 0) {

                    clearInterval(quizTimer);

                    mathQuiz.style.display = 'none';

                    endGame();

                }

            }, 1000);

        }



        function checkAnswer(selected, correct) {

            clearInterval(quizTimer);

            mathQuiz.style.display = 'none';

            

            if (selected === correct) {

                // –ù–∞–π—Ç–∏ –±–ª–∏–∂–∞–π—à—É—é –Ω–µ-—Ä–∞—Å—Å—ã–ø–∞—é—â—É—é—Å—è –ø–ª–∞—Ç—Ñ–æ—Ä–º—É

                let nearestPlatform = null;

                let minY = Infinity;

                

                platforms.forEach(p => {

                    if (!p.breakable && !p.toRemove && p.y < minY) {

                        minY = p.y;

                        nearestPlatform = p;

                    }

                });

                

                if (nearestPlatform) {

                    player.y = nearestPlatform.y - player.h - 5;

                    player.x = nearestPlatform.x + nearestPlatform.w / 2 - player.w / 2;

                    player.dy = -10;

                    gameOver = false;

                    if (soundEnabled) tg.HapticFeedback.notificationOccurred('success');

                } else {

                    endGame();

                }

            } else {

                endGame();

            }

        }



        function endGame() {

            if (score > bestScore) {

                bestScore = score;

                localStorage.setItem('bestScore', bestScore);

                document.getElementById('bestScore').textContent = bestScore;

            }

            startScreen.style.display = 'flex';

        }



        function init() {

            player.x = 135; player.y = 300; player.dy = 0; player.dx = 0;

            score = 0;

            scoreDiv.textContent = '0';

            particles = [];

            leftPressed = false;

            rightPressed = false;

            lastPressed = null;

            activeTouches.clear();

            createPlatforms();

            startScreen.style.display = 'none';

            menuScreen.style.display = 'none';

            gameOver = false;

            if(gameInterval) clearInterval(gameInterval);

            gameInterval = setInterval(update, 1000/60);

        }



        function update() {

            if(gameOver) return;



            player.dy += 0.28;

            player.y += player.dy;

            player.x += player.dx;



            if (player.x < -40) player.x = 320;

            if (player.x > 320) player.x = -40;



            let difficultyTier = Math.floor(score / 1000);

            if (difficultyTier > lastDifficultyTier) {

                currentPlatformWidth *= 0.9;

                lastDifficultyTier = difficultyTier;

                platforms.forEach(p => {

                    p.w = currentPlatformWidth;

                });

                if (soundEnabled) tg.HapticFeedback.notificationOccurred('success');

            }



            platforms = platforms.filter(p => !p.toRemove);



            platforms.forEach(p => {

                if (p.mv !== 0) {

                    p.x += p.mv;

                    if (p.x < -p.w) p.x = 320;

                    if (p.x > 320) p.x = -p.w;

                }



                if (player.dy > 0 && player.x + 10 < p.x + p.w && player.x + player.w - 10 > p.x &&

                    player.y + player.h > p.y && player.y + player.h < p.y + p.h + 12) {

                    

                    if (p.breakable && p.used) {

                        createBreakParticles(p);

                        p.toRemove = true;

                        if (soundEnabled) tg.HapticFeedback.impactOccurred('heavy');

                    } else {

                        player.dy = -10;

                        score += 20; 

                        if (soundEnabled) tg.HapticFeedback.impactOccurred('medium');

                        createGoldParticles(player.x, player.y);

                        

                        if (p.breakable) {

                            p.used = true;

                        }

                    }

                }

            });



            if (player.y < 200) {

                let offset = 200 - player.y;

                player.y = 200;

                score += Math.floor(offset); 

                scoreDiv.textContent = score;

                platforms.forEach(p => {

                    p.y += offset;

                    if (p.y > 500) {

                        p.y = -20;

                        p.x = Math.random() * (320 - currentPlatformWidth);

                        p.mv = Math.random() > 0.5 ? (Math.random() - 0.5) * (4 + difficultyTier) : 0;

                        p.breakable = Math.random() > 0.7;

                        p.used = false;

                        p.toRemove = false;

                    }

                });

                particles.forEach(part => part.y += offset);

            }



            if (player.y > 500) {

                gameOver = true;

                clearInterval(gameInterval);

                if (soundEnabled) tg.HapticFeedback.notificationOccurred('error');

                showMathQuiz();

            }



            for (let i = particles.length - 1; i >= 0; i--) {

                let part = particles[i];

                part.x += part.vx; part.y += part.vy;

                part.vy += 0.15; part.life--;

                if (part.life <= 0) particles.splice(i, 1);

            }



            draw();

        }



        function draw() {

            ctx.clearRect(0, 0, 320, 500);

            

            platforms.forEach(p => {

                if (p.breakable && p.used) {

                    // –¢—Ä–µ—Å–Ω—É–≤—à–∞—è –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞

                    drawCrackedPlatform(p.x, p.y, p.w, p.h, 6);

                } else {

                    // –û–±—ã—á–Ω—ã–µ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã

                    if (p.breakable) {

                        ctx.fillStyle = "#8B4513";

                    } else if (p.mv !== 0) {

                        ctx.fillStyle = "#ff4444";

                    } else {

                        ctx.fillStyle = "#2e7d32";

                    }

                    drawRoundedRect(p.x, p.y, p.w, p.h, 6);

                }

            });



            particles.forEach(part => {

                ctx.globalAlpha = part.life / 40;

                ctx.fillStyle = part.color;

                ctx.beginPath();

                ctx.arc(part.x, part.y, part.size, 0, Math.PI*2);

                ctx.fill();

                ctx.globalAlpha = 1;

            });



            if (playerImg.complete && playerImg.naturalWidth > 0) {

                ctx.drawImage(playerImg, player.x, player.y, player.w, player.h);

            } else {

                ctx.fillStyle = "#ff8f00";

                ctx.fillRect(player.x, player.y, player.w, player.h);

            }

        }



        const L = document.getElementById('left-btn');

        const R = document.getElementById('right-btn');



        function setLeftButton(pressed) {

            leftPressed = pressed;

            if (pressed) {

                lastPressed = 'left';

            } else {

                if (rightPressed) {

                    lastPressed = 'right';

                } else {

                    lastPressed = null;

                }

            }

            updatePlayerDirection();

        }



        function setRightButton(pressed) {

            rightPressed = pressed;

            if (pressed) {

                lastPressed = 'right';

            } else {

                if (leftPressed) {

                    lastPressed = 'left';

                } else {

                    lastPressed = null;

                }

            }

            updatePlayerDirection();

        }



        L.addEventListener('touchstart', (e) => { 

            e.preventDefault();

            for (let touch of e.changedTouches) {

                activeTouches.set(touch.identifier, 'left');

            }

            setLeftButton(true);

        }, { passive: false });



        L.addEventListener('touchend', (e) => { 

            e.preventDefault();

            for (let touch of e.changedTouches) {

                activeTouches.delete(touch.identifier);

            }

            let hasLeftTouch = Array.from(activeTouches.values()).includes('left');

            setLeftButton(hasLeftTouch);

        }, { passive: false });



        L.addEventListener('touchcancel', (e) => { 

            e.preventDefault();

            for (let touch of e.changedTouches) {

                activeTouches.delete(touch.identifier);

            }

            let hasLeftTouch = Array.from(activeTouches.values()).includes('left');

            setLeftButton(hasLeftTouch);

        }, { passive: false });



        R.addEventListener('touchstart', (e) => { 

            e.preventDefault();

            for (let touch of e.changedTouches) {

                activeTouches.set(touch.identifier, 'right');

            }

            setRightButton(true);

        }, { passive: false });



        R.addEventListener('touchend', (e) => { 

            e.preventDefault();

            for (let touch of e.changedTouches) {

                activeTouches.delete(touch.identifier);

            }

            let hasRightTouch = Array.from(activeTouches.values()).includes('right');

            setRightButton(hasRightTouch);

        }, { passive: false });



        R.addEventListener('touchcancel', (e) => { 

            e.preventDefault();

            for (let touch of e.changedTouches) {

                activeTouches.delete(touch.identifier);

            }

            let hasRightTouch = Array.from(activeTouches.values()).includes('right');

            setRightButton(hasRightTouch);

        }, { passive: false });



        L.addEventListener('mousedown', (e) => { 

            e.preventDefault(); 

            setLeftButton(true);

        });

        L.addEventListener('mouseup', (e) => { 

            e.preventDefault(); 

            setLeftButton(false);

        });

        L.addEventListener('mouseleave', (e) => { 

            setLeftButton(false);

        });



        R.addEventListener('mousedown', (e) => { 

            e.preventDefault(); 

            setRightButton(true);

        });

        R.addEventListener('mouseup', (e) => { 

            e.preventDefault(); 

            setRightButton(false);

        });

        R.addEventListener('mouseleave', (e) => { 

            setRightButton(false);

        });



        document.addEventListener('touchend', (e) => {

            for (let touch of e.changedTouches) {

                activeTouches.delete(touch.identifier);

            }

        }, { passive: true });



        // –ú–µ–Ω—é

        document.getElementById('menuButton').onclick = () => {

            menuScreen.style.display = 'flex';

        };



        document.getElementById('closeMenuBtn').onclick = () => {

            menuScreen.style.display = 'none';

        };



        // –†–µ–∂–∏–º—ã –∏–≥—Ä—ã

        document.getElementById('modeClassic').onclick = function() {

            gameMode = 'classic';

            document.getElementById('modeClassic').classList.add('active');

            document.getElementById('modeAnal').classList.remove('active');

        };



        document.getElementById('modeAnal').onclick = function() {

            gameMode = 'anal';

            document.getElementById('modeAnal').classList.add('active');

            document.getElementById('modeClassic').classList.remove('active');

        };



        // –ó–≤—É–∫

        document.getElementById('soundOn').onclick = function() {

            soundEnabled = true;

            document.getElementById('soundOn').classList.add('active');

            document.getElementById('soundOff').classList.remove('active');

        };



        document.getElementById('soundOff').onclick = function() {

            soundEnabled = false;

            document.getElementById('soundOff').classList.add('active');

            document.getElementById('soundOn').classList.remove('active');

        };



        // –¢–µ–º–∞

        document.getElementById('themeLight').onclick = function() {

            darkTheme = false;

            document.body.classList.remove('dark-theme');

            document.getElementById('themeLight').classList.add('active');

            document.getElementById('themeDark').classList.remove('active');

        };



        document.getElementById('themeDark').onclick = function() {

            darkTheme = true;

            document.body.classList.add('dark-theme');

            document.getElementById('themeDark').classList.add('active');

            document.getElementById('themeLight').classList.remove('active');

        };



        document.getElementById('start-button').onclick = init;

        draw();

    </script>

</body>

</html>
