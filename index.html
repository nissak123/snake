<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Game</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body {
            margin: 0; padding: 0; background: #ffffff;
            display: flex; justify-content: center; align-items: center;
            height: 100vh; overflow: hidden; font-family: sans-serif;
            touch-action: none; -webkit-user-select: none;
        }
        #gameCanvas {
            border: 2px solid #000;
            background: #fff;
            max-width: 100%;
            max-height: 80vh;
        }
    </style>
</head>
<body>

<canvas id="gameCanvas" width="320" height="500"></canvas>

<script>
    // 1. Принудительная готовность Telegram
    const tg = window.Telegram.WebApp;
    tg.ready();
    tg.expand();
    tg.enableClosingConfirmation();

    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');

    // Загрузка фото
    const playerImg = new Image();
    playerImg.src = 'player.png?v=' + Date.now();

    // Состояние игры
    let gameState = 'START'; // START, PLAY, OVER
    let score = 0;
    let player = { x: 135, y: 300, w: 50, h: 50, dx: 0, dy: 0 };
    let platforms = [];
    let particles = [];
    let platWidth = 70;

    // Инициализация платформ
    function initPlatforms() {
        platforms = [];
        platWidth = 70;
        platforms.push({ x: 110, y: 400, w: 100, h: 15, mv: 0 });
        for(let i = 1; i < 7; i++) {
            platforms.push({ 
                x: Math.random() * 240, 
                y: 400 - (i * 80), 
                w: 70, h: 12, 
                mv: Math.random() > 0.7 ? 2 : 0 
            });
        }
    }

    function resetGame() {
        score = 0;
        player = { x: 135, y: 300, w: 50, h: 50, dx: 0, dy: 0 };
        initPlatforms();
        gameState = 'PLAY';
    }

    // Обработка касаний
    function handleInput(e) {
        e.preventDefault();
        const rect = canvas.getBoundingClientRect();
        const touchX = (e.touches ? e.touches[0].clientX : e.clientX) - rect.left;
        const touchY = (e.touches ? e.touches[0].clientY : e.clientY) - rect.top;

        if (gameState === 'START' || gameState === 'OVER') {
            resetGame();
            return;
        }

        if (gameState === 'PLAY') {
            // Если нажали в левой части экрана - летим влево, в правой - вправо
            if (touchX < 160) player.dx = -5;
            else player.dx = 5;
        }
    }

    function stopInput() {
        player.dx = 0;
    }

    canvas.addEventListener('touchstart', handleInput);
    canvas.addEventListener('mousedown', handleInput);
    window.addEventListener('touchend', stopInput);
    window.addEventListener('mouseup', stopInput);

    function update() {
        if (gameState !== 'PLAY') return;

        player.dy += 0.28;
        player.y += player.dy;
        player.x += player.dx;

        // Переход через границы
        if (player.x < -30) player.x = 320;
        if (player.x > 320) player.x = -30;

        // Прыжки
        platforms.forEach(p => {
            if (p.mv) {
                p.x += p.mv;
                if (p.x <= 0 || p.x + p.w >= 320) p.mv *= -1;
            }
            if (player.dy > 0 && player.x < p.x + p.w && player.x + player.w > p.x &&
                player.y + player.h > p.y && player.y + player.h < p.y + p.h + 10) {
                player.dy = -10;
                score += 100;
                tg.HapticFeedback.impactOccurred('medium');
            }
        });

        // Движение камеры
        if (player.y < 200) {
            let offset = 200 - player.y;
            player.y = 200;
            platforms.forEach(p => {
                p.y += offset;
                if (p.y > 500) {
                    p.y = -20;
                    p.x = Math.random() * (320 - platWidth);
                    if (score > 2000) platWidth = 35; // Уменьшение после 2000 очков
                }
            });
        }

        // Проигрыш
        if (player.y > 500) {
            gameState = 'OVER';
            tg.HapticFeedback.notificationOccurred('error');
        }
    }

    function draw() {
        ctx.fillStyle = "#ffffff";
        ctx.fillRect(0, 0, 320, 500);

        if (gameState === 'START') {
            ctx.fillStyle = "#2481cc";
            ctx.fillRect(60, 200, 200, 60);
            ctx.fillStyle = "#fff";
            ctx.font = "20px Arial";
            ctx.fillText("НАЖМИ, ЧТОБЫ ИГРАТЬ", 70, 235);
            return;
        }

        if (gameState === 'PLAY' || gameState === 'OVER') {
            // Платформы
            ctx.fillStyle = "green";
            platforms.forEach(p => ctx.fillRect(p.x, p.y, p.w, p.h));

            // Игрок
            if (playerImg.complete && playerImg.naturalWidth !== 0) {
                ctx.drawImage(playerImg, player.x, player.y, player.w, player.h);
            } else {
                ctx.fillStyle = "orange";
                ctx.fillRect(player.x, player.y, player.w, player.h);
            }

            // Счет
            ctx.fillStyle = "#000";
            ctx.font = "20px Arial";
            ctx.fillText("Score: " + score, 10, 30);

            if (gameState === 'OVER') {
                ctx.fillStyle = "rgba(0,0,0,0.5)";
                ctx.fillRect(0,0,320,500);
                ctx.fillStyle = "#fff";
                ctx.fillText("GAME OVER! НАЖМИ ДЛЯ РЕСТАРТА", 10, 250);
            }
        }
    }

    function gameLoop() {
        update();
        draw();
        requestAnimationFrame(gameLoop);
    }

    gameLoop();
</script>
</body>
</html>
