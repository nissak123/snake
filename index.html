<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Doodle Jump App</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --bg-color: var(--tg-theme-bg-color, #f8f8f8);
            --text-color: var(--tg-theme-text-color, #000000);
            --button-color: var(--tg-theme-button-color, #2481cc);
            --button-text: var(--tg-theme-button-text-color, #ffffff);
            --secondary-bg: var(--tg-theme-secondary-bg-color, #e8e8e8);
            --main-font: 'Comic Sans MS', cursive, sans-serif; /* Для дудл-стиля */
        }

        body {
            font-family: var(--main-font);
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            overflow: hidden;
            touch-action: manipulation;
            user-select: none;
            -webkit-user-select: none;
            -ms-user-select: none;
        }

        #gameContainer {
            position: relative;
            width: 320px; /* Ширина игры */
            height: 568px; /* Высота игры (как у телефона) */
            border: 4px solid var(--button-color);
            border-radius: 12px;
            overflow: hidden;
            background-color: #aaddff; /* Светло-голубое небо */
            box-shadow: 0 8px 20px rgba(0,0,0,0.3);
            margin-bottom: 20px;
        }

        #gameCanvas {
            position: absolute;
            top: 0;
            left: 0;
        }

        #score {
            position: absolute;
            top: 10px;
            left: 10px;
            font-size: 28px;
            font-weight: bold;
            color: #2e7d32; /* Темно-зеленый, как в оригинале */
            text-shadow: 2px 2px 0px rgba(255,255,255,0.7);
            z-index: 10;
        }

        #startScreen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 20;
        }

        #startScreen h1 {
            color: #ffeb3b; /* Желтый заголовок */
            font-size: 48px;
            margin-bottom: 20px;
            text-shadow: 3px 3px 0px rgba(0,0,0,0.5);
        }

        #start-button {
            padding: 15px 40px;
            font-size: 22px;
            background-color: var(--button-color);
            color: var(--button-text);
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-weight: bold;
            box-shadow: 0 6px 15px rgba(0,0,0,0.3);
            -webkit-tap-highlight-color: transparent;
        }
        #start-button:active {
            transform: scale(0.95);
            filter: brightness(0.9);
        }

        #controls {
            position: absolute; /* Контролы будут поверх канваса */
            bottom: 10px;
            width: 100%;
            display: flex;
            justify-content: space-around;
            padding: 0 20px; /* Отступы по бокам */
            box-sizing: border-box;
            z-index: 15; /* Выше канваса */
        }

        .control-btn {
            width: 80px;
            height: 80px;
            background-color: var(--button-color);
            color: var(--button-text);
            border: none;
            border-radius: 50%;
            font-size: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            -webkit-tap-highlight-color: transparent;
            user-select: none;
        }
        .control-btn:active {
            transform: scale(0.95);
            filter: brightness(0.9);
        }
    </style>
</head>
<body>

    <div id="gameContainer">
        <canvas id="gameCanvas" width="320" height="568"></canvas>
        <div id="score">0</div>

        <div id="startScreen">
            <h1>Doodle Jump!</h1>
            <button id="start-button">Начать игру</button>
        </div>

        <div id="controls">
            <button id="left-btn" class="control-btn">◀</button>
            <button id="right-btn" class="control-btn">▶</button>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();

        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const scoreDisplay = document.getElementById('score');
        const startScreen = document.getElementById('startScreen');
        const startButton = document.getElementById('start-button');
        const leftButton = document.getElementById('left-btn');
        const rightButton = document.getElementById('right-btn');
        const gameContainer = document.getElementById('gameContainer');

        const GAME_WIDTH = canvas.width;
        const GAME_HEIGHT = canvas.height;

        // Player settings
        const player = {
            x: GAME_WIDTH / 2 - 25,
            y: GAME_HEIGHT - 100,
            width: 50,
            height: 50,
            dy: 0, // velocity y
            dx: 0, // velocity x
            jumpPower: -10,
            gravity: 0.3,
            onPlatform: false
        };

        // Platform settings
        const platforms = [];
        const PLATFORM_WIDTH = 60;
        const PLATFORM_HEIGHT = 10;
        const PLATFORM_GAP = 60; // Расстояние между платформами

        let score = 0;
        let gameOver = true;
        let cameraY = 0; // Для смещения игрового мира при подъеме
        let lastPlatformY = GAME_HEIGHT; // Y последней созданной платформы

        // Game loop interval
        let gameInterval;

        // --- Game Initialization ---
        function initGame() {
            player.x = GAME_WIDTH / 2 - player.width / 2;
            player.y = GAME_HEIGHT - 100;
            player.dy = 0;
            player.dx = 0;
            player.onPlatform = false;

            platforms.length = 0; // Clear platforms
            score = 0;
            scoreDisplay.textContent = '0';
            cameraY = 0;
            lastPlatformY = GAME_HEIGHT;

            // Generate initial platforms
            generatePlatform(GAME_WIDTH / 2 - PLATFORM_WIDTH / 2, GAME_HEIGHT - 30, true); // Starting platform
            for (let i = 0; i < 8; i++) {
                generateRandomPlatform();
            }

            startScreen.style.display = 'none';
            gameOver = false;
            if (gameInterval) clearInterval(gameInterval);
            gameInterval = setInterval(gameLoop, 1000 / 60); // 60 FPS
        }

        // --- Platform Generation ---
        function generatePlatform(x, y, isStarting = false) {
            platforms.push({ x: x, y: y, width: PLATFORM_WIDTH, height: PLATFORM_HEIGHT, isStarting: isStarting });
        }

        function generateRandomPlatform() {
            const minX = 0;
            const maxX = GAME_WIDTH - PLATFORM_WIDTH;
            const newX = Math.random() * (maxX - minX) + minX;
            lastPlatformY -= (PLATFORM_GAP + Math.random() * 20); // Немного рандома
            generatePlatform(newX, lastPlatformY);
        }

        // --- Drawing Functions ---
        function drawPlayer() {
            ctx.fillStyle = '#ff8f00'; // Оранжевый doodle
            ctx.fillRect(player.x, player.y + cameraY, player.width, player.height);
            // Глазки для doodle
            ctx.fillStyle = 'white';
            ctx.fillRect(player.x + 10, player.y + cameraY + 10, 8, 8);
            ctx.fillRect(player.x + player.width - 18, player.y + cameraY + 10, 8, 8);
            ctx.fillStyle = 'black';
            ctx.fillRect(player.x + 12, player.y + cameraY + 12, 4, 4);
            ctx.fillRect(player.x + player.width - 16, player.y + cameraY + 12, 4, 4);
        }

        function drawPlatforms() {
            ctx.fillStyle = '#2e7d32'; // Зеленые платформы
            platforms.forEach(p => {
                ctx.fillRect(p.x, p.y + cameraY, p.width, p.height);
            });
        }

        function drawGame() {
            ctx.clearRect(0, 0, GAME_WIDTH, GAME_HEIGHT);
            drawPlatforms();
            drawPlayer();
        }

        // --- Game Logic ---
        function gameLoop() {
            if (gameOver) return;

            // Apply gravity
            player.dy += player.gravity;
            player.y += player.dy;

            // Move player horizontally
            player.x += player.dx;

            // Wrap around screen horizontally
            if (player.x + player.width < 0) {
                player.x = GAME_WIDTH;
            } else if (player.x > GAME_WIDTH) {
                player.x = -player.width;
            }

            // Camera movement
            if (player.y + cameraY < GAME_HEIGHT / 2) {
                cameraY = GAME_HEIGHT / 2 - player.y;
                score = Math.max(score, Math.floor(-player.y / 10)); // Score based on height
                scoreDisplay.textContent = score;
            }

            // Platform collision
            player.onPlatform = false;
            platforms.forEach(p => {
                if (
                    player.dy > 0 && // Only check when falling
                    player.x < p.x + p.width &&
                    player.x + player.width > p.x &&
                    player.y + player.height > p.y &&
                    player.y + player.height < p.y + p.height // Head hit top of platform
                ) {
                    player.dy = player.jumpPower; // Jump!
                    player.onPlatform = true;
                    tg.HapticFeedback.impactOccurred('light'); // Vibration on jump
                }
            });

            // Remove old platforms and generate new ones
            for (let i = 0; i < platforms.length; i++) {
                if (platforms[i].y + cameraY > GAME_HEIGHT) {
                    platforms.splice(i, 1);
                    i--; // Adjust index after splice
                    generateRandomPlatform();
                }
            }
            
            // Game over condition
            if (player.y - cameraY > GAME_HEIGHT) {
                gameOver = true;
                clearInterval(gameInterval);
                tg.HapticFeedback.notificationOccurred('error');
                alert(`Игра окончена! Ваш счет: ${score}`);
                startScreen.style.display = 'flex';
                // Reset score text on start screen
                startScreen.querySelector('h1').textContent = `Ваш счет: ${score}`;
            }

            drawGame();
        }

        // --- Input Handling ---
        let currentDirection = 0; // -1 for left, 1 for right, 0 for stop

        function setDirection(dir) {
            currentDirection = dir;
            player.dx = currentDirection * 5; // Adjust speed
            tg.HapticFeedback.impactOccurred('light');
        }

        function stopDirection() {
            currentDirection = 0;
            player.dx = 0;
        }

        // Mobile controls
        leftButton.addEventListener('touchstart', (e) => { e.preventDefault(); setDirection(-1); }, {passive: false});
        leftButton.addEventListener('touchend', stopDirection);
        leftButton.addEventListener('click', () => setDirection(-1)); // Fallback for click (desktop testing)
        
        rightButton.addEventListener('touchstart', (e) => { e.preventDefault(); setDirection(1); }, {passive: false});
        rightButton.addEventListener('touchend', stopDirection);
        rightButton.addEventListener('click', () => setDirection(1)); // Fallback for click (desktop testing)


        // Keyboard controls (for desktop testing)
        document.addEventListener('keydown', (e) => {
            if (e.key === 'ArrowLeft') setDirection(-1);
            if (e.key === 'ArrowRight') setDirection(1);
        });

        document.addEventListener('keyup', (e) => {
            if (e.key === 'ArrowLeft' || e.key === 'ArrowRight') stopDirection();
        });

        // Start button handler
        startButton.addEventListener('click', initGame);

        // Initial draw
        drawGame();
    </script>
</body>
</html>
